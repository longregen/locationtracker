name: E2E Test

on:
  workflow_call:
    inputs:
      artifact-name-prefix:
        description: 'Prefix for artifact names (e.g., "ci" or "release")'
        required: false
        type: string
        default: 'e2e'

jobs:
  e2e-test:
    name: Run E2E Tests on Android Emulator
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write  # Required to checkout code and push screenshot updates
      pull-requests: write  # Required to create PRs for screenshot updates

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Set up JDK 17
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          cache-read-only: false
          gradle-home-cache-cleanup: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build debug APK and test APK
        run: |
          ./gradlew assembleDebug assembleDebugAndroidTest \
            --parallel \
            --build-cache \
            --configuration-cache \
            --no-daemon \
            --stacktrace

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-e2e-33-google_apis-x86_64

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@b530d96654c385303d652368551fb075bc2f0b6b # v2.35.0
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          script: |
            echo "Waiting for all Android services to be ready..."
            adb wait-for-device
            adb shell 'while [ "$(getprop sys.boot_completed)" != "1" ]; do sleep 2; done'
            adb shell 'while [ -z "$(pm list packages)" ]; do sleep 1; done'
            adb shell 'while [ "$(getprop init.svc.bootanim)" != "stopped" ]; do sleep 1; done'
            echo "Boot completed. Waiting for input service..."
            i=0; while [ $i -lt 30 ]; do if adb shell service check input 2>/dev/null | grep -q "Service input:"; then echo "Input service is ready"; break; fi; echo "Waiting for input service... ($i/30)"; sleep 2; i=$((i+1)); done
            echo "Waiting for settings service..."
            i=0; while [ $i -lt 30 ]; do if adb shell service check settings 2>/dev/null | grep -q "Service settings:"; then echo "Settings service is ready"; break; fi; echo "Waiting for settings service... ($i/30)"; sleep 2; i=$((i+1)); done
            echo "Adding 5 second stabilization period..."
            sleep 5
            echo "All services ready. Generated AVD snapshot for caching."

      - name: Run E2E tests on Android Emulator
        uses: reactivecircus/android-emulator-runner@b530d96654c385303d652368551fb075bc2f0b6b # v2.35.0
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            set -x
            echo "=== Starting E2E Test Script ==="
            adb wait-for-device
            echo "Device connected"
            adb shell 'while [ "$(getprop sys.boot_completed)" != "1" ]; do echo "Waiting for boot..."; sleep 2; done; echo "Boot completed"'
            adb shell 'while [ -z "$(pm list packages)" ]; do echo "Waiting for package manager..."; sleep 1; done; echo "Package manager ready"'
            adb shell 'while [ "$(getprop init.svc.bootanim)" != "stopped" ]; do echo "Waiting for bootanim..."; sleep 1; done; echo "Bootanim stopped"'
            echo "Waiting for input service to be ready..."
            i=0; while [ $i -lt 30 ]; do if adb shell service check input 2>/dev/null | grep -q "Service input:"; then echo "Input service is ready"; break; fi; echo "Waiting for input service... ($i/30)"; sleep 2; i=$((i+1)); done
            echo "Waiting for settings service to be ready..."
            i=0; while [ $i -lt 30 ]; do if adb shell service check settings 2>/dev/null | grep -q "Service settings:"; then echo "Settings service is ready"; break; fi; echo "Waiting for settings service... ($i/30)"; sleep 2; i=$((i+1)); done
            echo "Adding 5 second stabilization period..."
            sleep 5
            echo "Configuring emulator settings..."
            adb shell settings put global window_animation_scale 0.0
            adb shell settings put global transition_animation_scale 0.0
            adb shell settings put global animator_duration_scale 0.0
            adb shell appops set com.locationtracker android:mock_location allow || echo "Mock location permission already set"
            echo "Setting initial location to London (51.5074, -0.1278)"
            adb emu geo fix -0.1278 51.5074
            sleep 2
            echo "Installing APKs..."
            adb install -r app/build/outputs/apk/debug/app-x86_64-debug.apk
            adb install -r app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk
            echo "Granting permissions..."
            adb shell pm grant com.locationtracker android.permission.ACCESS_FINE_LOCATION
            adb shell pm grant com.locationtracker android.permission.ACCESS_COARSE_LOCATION
            adb shell pm grant com.locationtracker android.permission.POST_NOTIFICATIONS
            adb shell mkdir -p /sdcard/Pictures
            echo "Running E2E test..."
            mkdir -p test-results
            adb shell am instrument -w -r -e debug false -e class com.locationtracker.LocationTrackerE2ETest com.locationtracker.test/androidx.test.runner.AndroidJUnitRunner | tee test-results/test-output.txt
            TEST_EXIT_CODE=$?
            echo "Test execution completed. Exit code: $TEST_EXIT_CODE"
            echo "Pulling screenshots..."
            mkdir -p screenshots
            adb pull /sdcard/Pictures/ screenshots/ || echo "No screenshots found"
            echo "Screenshots captured:"
            ls -la screenshots/Pictures/ || echo "No screenshots directory"
            echo "=== E2E Test Script Completed ==="
            exit $TEST_EXIT_CODE

      - name: Compare and update reference screenshot
        if: always() && hashFiles('screenshots/Pictures/01_app_launched.png') != ''
        run: |
          set -x
          SCREENSHOT_NEW="screenshots/Pictures/01_app_launched.png"
          SCREENSHOT_REF="images/main-view.png"

          # Check if new screenshot exists
          if [ ! -f "$SCREENSHOT_NEW" ]; then
            echo "No new screenshot found, skipping comparison"
            exit 0
          fi

          # Strip metadata from new screenshot to ensure consistent storage
          echo "Stripping metadata from new screenshot..."
          sudo apt-get update -qq && sudo apt-get install -y -qq optipng > /dev/null 2>&1

          # Create normalized version without metadata
          SCREENSHOT_NEW_NORMALIZED="screenshots/Pictures/01_app_launched_normalized.png"
          cp "$SCREENSHOT_NEW" "$SCREENSHOT_NEW_NORMALIZED"
          optipng -strip all "$SCREENSHOT_NEW_NORMALIZED" 2>/dev/null || echo "optipng failed, using original"

          # If optipng succeeded, use normalized version
          if [ -f "$SCREENSHOT_NEW_NORMALIZED" ]; then
            SCREENSHOT_NEW="$SCREENSHOT_NEW_NORMALIZED"
          fi

          # Check if reference exists and compute hashes for logging
          if [ -f "$SCREENSHOT_REF" ]; then
            echo "Current reference SHA256: $(sha256sum "$SCREENSHOT_REF" | cut -d' ' -f1)"
            echo "New screenshot SHA256: $(sha256sum "$SCREENSHOT_NEW" | cut -d' ' -f1)"
          else
            echo "â„¹ No reference screenshot found - will create initial version"
          fi

          # Create update branch
          BRANCH_NAME="ci/update-main-view-screenshot-${{ github.run_id }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Fetch latest refs to check remote state
          git fetch origin

          # Delete remote branch if it already exists
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || echo "Branch doesn't exist remotely yet"

          # Create and switch to new branch from the current commit
          git checkout -b "$BRANCH_NAME"

          # Copy normalized screenshot to reference location (metadata already stripped)
          mkdir -p images
          cp "$SCREENSHOT_NEW" "$SCREENSHOT_REF"

          # Verify the file is normalized
          echo "Reference screenshot size: $(wc -c < "$SCREENSHOT_REF") bytes"

          # Commit the change
          git add "$SCREENSHOT_REF"
          git commit -m "ci: Update main view reference screenshot

          Automated update from E2E test run ${{ github.run_id }}

          Source: ${{ github.ref }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Push the branch (force push in case of conflicts)
          git push -u origin "$BRANCH_NAME" --force

          # Create PR using GitHub CLI (with error handling)
          echo "Attempting to create pull request..."
          if gh pr create \
            --title "Update main view reference screenshot" \
            --body "## Screenshot Update from E2E Tests

          The main view screenshot from the latest E2E test run.

          **Details:**
          - Workflow: \`${{ github.workflow }}\`
          - Run ID: \`${{ github.run_id }}\`
          - Source Branch: \`${{ github.ref }}\`
          - Test Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Review:
          1. ðŸ” Review the visual appearance in this PR
          2. âœ… If the screenshot looks correct, merge this PR
          3. âŒ If there are issues, investigate the test run

          View the screenshot directly: [\`images/main-view.png\`](/${{ github.repository }}/blob/$BRANCH_NAME/images/main-view.png)

          **Note:** Minor differences (like timestamps) are expected." \
            --base "${{ github.event.repository.default_branch || 'main' }}" \
            --head "$BRANCH_NAME" \
            --label "automated" \
            --label "screenshots" 2>&1; then
            echo "âœ“ PR created successfully"
          else
            echo "âš  Could not create PR automatically. This may be due to repository permissions."
            echo "ðŸ“‹ Branch '$BRANCH_NAME' has been pushed with the updated screenshot."
            echo "ðŸ”— Create PR manually at: ${{ github.server_url }}/${{ github.repository }}/pull/new/$BRANCH_NAME"
            echo ""
            echo "â„¹ï¸  To enable automatic PR creation, go to:"
            echo "   Settings -> Actions -> General -> Workflow permissions"
            echo "   and enable 'Allow GitHub Actions to create and approve pull requests'"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload main view screenshot
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ${{ inputs.artifact-name-prefix }}-main-view
          path: screenshots/Pictures/01_app_launched.png
          compression-level: 0
          if-no-files-found: warn
          retention-days: 30

      - name: Upload E2E test screenshots
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ${{ inputs.artifact-name-prefix }}-screenshots
          path: screenshots/
          retention-days: 30

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ${{ inputs.artifact-name-prefix }}-test-results
          path: |
            test-results/
            app/build/reports/androidTests/
            app/build/outputs/androidTest-results/
          if-no-files-found: warn
          retention-days: 30
