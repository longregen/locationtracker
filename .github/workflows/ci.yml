name: CI - Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # CodeQL security analysis runs in parallel with build/test
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Set up JDK 17
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          cache-disabled: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Download and setup CodeQL CLI
        run: |
          # Download CodeQL CLI
          wget -q https://github.com/github/codeql-action/releases/latest/download/codeql-bundle-linux64.tar.gz
          tar -xzf codeql-bundle-linux64.tar.gz
          echo "$GITHUB_WORKSPACE/codeql" >> $GITHUB_PATH

      - name: Create CodeQL database
        run: |
          codeql database create codeql-db \
            --language=java \
            --command="./gradlew clean assembleDebug --no-daemon" \
            --source-root=.

      - name: Analyze CodeQL database
        run: |
          codeql database analyze codeql-db \
            --format=sarif-latest \
            --output=codeql-results.sarif \
            java-security-and-quality

      - name: Upload SARIF to GitHub
        run: |
          # Get the commit SHA and ref
          COMMIT_SHA="${{ github.sha }}"
          REF="${{ github.ref }}"

          # Upload SARIF file using GitHub API
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/code-scanning/sarifs" \
            -d @- <<EOF
          {
            "commit_sha": "$COMMIT_SHA",
            "ref": "$REF",
            "sarif": "$(cat codeql-results.sarif | base64 -w 0)"
          }
          EOF

      - name: Upload SARIF as artifact
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: codeql-sarif
          path: codeql-results.sarif
          retention-days: 30

  # Nix build and E2E tests run in parallel with CodeQL
  build-and-test:
    name: Build with Nix and Test E2E
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write  # Required to checkout code and push screenshot updates
      pull-requests: write  # Required to create PRs for screenshot updates

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run E2E tests with Nix
        run: |
          echo "Running E2E tests using Nix..."
          nix run .#e2e-tests

      - name: Compare and update reference screenshot
        if: always() && hashFiles('screenshots/Pictures/01_app_launched.png') != ''
        run: |
          set -x
          SCREENSHOT_NEW="screenshots/Pictures/01_app_launched.png"
          SCREENSHOT_REF="images/main-view.png"

          # Check if new screenshot exists
          if [ ! -f "$SCREENSHOT_NEW" ]; then
            echo "No new screenshot found, skipping comparison"
            exit 0
          fi

          # Strip metadata from new screenshot to ensure consistent storage
          echo "Stripping metadata from new screenshot..."
          sudo apt-get update -qq && sudo apt-get install -y -qq optipng > /dev/null 2>&1

          # Create normalized version without metadata
          SCREENSHOT_NEW_NORMALIZED="screenshots/Pictures/01_app_launched_normalized.png"
          cp "$SCREENSHOT_NEW" "$SCREENSHOT_NEW_NORMALIZED"
          optipng -strip all "$SCREENSHOT_NEW_NORMALIZED" 2>/dev/null || echo "optipng failed, using original"

          # If optipng succeeded, use normalized version
          if [ -f "$SCREENSHOT_NEW_NORMALIZED" ]; then
            SCREENSHOT_NEW="$SCREENSHOT_NEW_NORMALIZED"
          fi

          # Check if reference exists and compute hashes for logging
          if [ -f "$SCREENSHOT_REF" ]; then
            echo "Current reference SHA256: $(sha256sum "$SCREENSHOT_REF" | cut -d' ' -f1)"
            echo "New screenshot SHA256: $(sha256sum "$SCREENSHOT_NEW" | cut -d' ' -f1)"
          else
            echo "â„¹ No reference screenshot found - will create initial version"
          fi

          # Create update branch
          BRANCH_NAME="ci/update-main-view-screenshot-${{ github.run_id }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Fetch latest refs to check remote state
          git fetch origin

          # Delete remote branch if it already exists
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || echo "Branch doesn't exist remotely yet"

          # Create and switch to new branch from the current commit
          git checkout -b "$BRANCH_NAME"

          # Copy normalized screenshot to reference location (metadata already stripped)
          mkdir -p images
          cp "$SCREENSHOT_NEW" "$SCREENSHOT_REF"

          # Verify the file is normalized
          echo "Reference screenshot size: $(wc -c < "$SCREENSHOT_REF") bytes"

          # Commit the change
          git add "$SCREENSHOT_REF"
          git commit -m "ci: Update main view reference screenshot

          Automated update from E2E test run ${{ github.run_id }}

          Source: ${{ github.ref }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Push the branch (force push in case of conflicts)
          git push -u origin "$BRANCH_NAME" --force

          # Create PR using GitHub CLI (with error handling)
          echo "Attempting to create pull request..."
          if gh pr create \
            --title "Update main view reference screenshot" \
            --body "## Screenshot Update from E2E Tests

          The main view screenshot from the latest E2E test run.

          **Details:**
          - Workflow: \`${{ github.workflow }}\`
          - Run ID: \`${{ github.run_id }}\`
          - Source Branch: \`${{ github.ref }}\`
          - Test Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Review:
          1. ðŸ” Review the visual appearance in this PR
          2. âœ… If the screenshot looks correct, merge this PR
          3. âŒ If there are issues, investigate the test run

          View the screenshot directly: [\`images/main-view.png\`](/${{ github.repository }}/blob/$BRANCH_NAME/images/main-view.png)

          **Note:** Minor differences (like timestamps) are expected." \
            --base "${{ github.event.repository.default_branch || 'main' }}" \
            --head "$BRANCH_NAME" \
            --label "automated" \
            --label "screenshots" 2>&1; then
            echo "âœ“ PR created successfully"
          else
            echo "âš  Could not create PR automatically. This may be due to repository permissions."
            echo "ðŸ“‹ Branch '$BRANCH_NAME' has been pushed with the updated screenshot."
            echo "ðŸ”— Create PR manually at: ${{ github.server_url }}/${{ github.repository }}/pull/new/$BRANCH_NAME"
            echo ""
            echo "â„¹ï¸  To enable automatic PR creation, go to:"
            echo "   Settings -> Actions -> General -> Workflow permissions"
            echo "   and enable 'Allow GitHub Actions to create and approve pull requests'"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload main view screenshot
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ci-main-view
          path: screenshots/Pictures/01_app_launched.png
          compression-level: 0
          if-no-files-found: warn
          retention-days: 30

      - name: Upload E2E test screenshots
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ci-screenshots
          path: screenshots/
          retention-days: 30

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ci-test-results
          path: |
            test-results/
            app/build/reports/androidTests/
            app/build/outputs/androidTest-results/
          if-no-files-found: warn
          retention-days: 30

  # Auto-bump version and create tag after successful build on main
  auto-version-and-tag:
    name: Auto Bump Version and Tag
    needs: build-and-test
    # Only run on main branch pushes (not PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push commits and create tags

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0  # Fetch all history to get tags

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Get latest tag and calculate new version
        id: bump_version
        run: |
          # Fetch all tags
          git fetch --tags

          # Get the latest tag (defaults to v0.0.0 if no tags exist)
          LATEST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -n1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tags found, starting with v1.0.0"
            NEW_VERSION="1.0.0"
            NEW_VERSION_CODE=1
          else
            echo "Latest tag: $LATEST_TAG"

            # Remove 'v' prefix and split version
            VERSION=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

            # Bump patch version by default
            PATCH=$((PATCH + 1))

            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            # Calculate version code as MAJOR*10000 + MINOR*100 + PATCH
            NEW_VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          fi

          echo "New version: $NEW_VERSION"
          echo "New version code: $NEW_VERSION_CODE"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_version_code=$NEW_VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Update build.gradle with new version
        env:
          NEW_VERSION: ${{ steps.bump_version.outputs.new_version }}
          NEW_VERSION_CODE: ${{ steps.bump_version.outputs.new_version_code }}
        run: |
          BUILD_GRADLE="app/build.gradle"

          # Extract current versions for logging
          CURRENT_VERSION_CODE=$(grep -oP 'versionCode\s+\K\d+' "$BUILD_GRADLE")
          CURRENT_VERSION_NAME=$(grep -oP 'versionName\s+"\K[^"]+' "$BUILD_GRADLE")

          echo "Current versionCode: $CURRENT_VERSION_CODE"
          echo "Current versionName: $CURRENT_VERSION_NAME"
          echo "New versionCode: $NEW_VERSION_CODE"
          echo "New versionName: $NEW_VERSION"

          # Update build.gradle using sed
          sed -i "s/versionCode $CURRENT_VERSION_CODE/versionCode $NEW_VERSION_CODE/" "$BUILD_GRADLE"
          sed -i "s/versionName \"$CURRENT_VERSION_NAME\"/versionName \"$NEW_VERSION\"/" "$BUILD_GRADLE"

          # Verify changes
          echo "Updated build.gradle:"
          grep -A 2 "versionCode\|versionName" "$BUILD_GRADLE" | head -6

      - name: Commit version bump and create tag
        env:
          NEW_VERSION: ${{ steps.bump_version.outputs.new_version }}
          NEW_VERSION_CODE: ${{ steps.bump_version.outputs.new_version_code }}
        run: |
          NEW_TAG="v${NEW_VERSION}"

          # Check if there are changes to commit
          if git diff --quiet app/build.gradle; then
            echo "No version changes detected, skipping commit and tag"
            exit 0
          fi

          # Commit the version bump
          git add app/build.gradle
          git commit -m "chore: Bump version to ${NEW_VERSION} (${NEW_VERSION_CODE})

          Auto-generated version bump after successful build and E2E tests

          - versionCode: ${NEW_VERSION_CODE}
          - versionName: ${NEW_VERSION}

          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          Commit: ${{ github.sha }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Push the commit
          git push origin main

          # Create and push the tag
          git tag -a "$NEW_TAG" -m "Release ${NEW_TAG}

          Auto-generated release tag after successful build and E2E tests

          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          Commit: $(git rev-parse HEAD)
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git push origin "$NEW_TAG"

          echo "âœ“ Created and pushed tag: $NEW_TAG"
          echo "âœ“ Committed version bump to main"
          echo "This will trigger the release workflow to build signed APKs"
