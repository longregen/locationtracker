name: CI - Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Lightweight build check for PRs - just compile, no emulator or E2E tests
  build-check:
    name: Build Check (Nix)
    permissions:
      contents: read
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Build debug APK (compile check)
        run: |
          nix develop --command bash -c '
            export ANDROID_HOME="${ANDROID_HOME:-$ANDROID_SDK_ROOT}"
            gradle assembleDebug \
              -Pandroid.injected.abi=armeabi-v7a \
              --no-daemon \
              --stacktrace
          '

      - name: Upload debug APK
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7
          if-no-files-found: error

      - name: Run unit tests
        run: |
          nix develop --command bash -c '
            export ANDROID_HOME="${ANDROID_HOME:-$ANDROID_SDK_ROOT}"
            gradle testDebugUnitTest --no-daemon || echo "No unit tests found"
          '

  # Full E2E tests only on main branch pushes (validation only, releases are manual)
  e2e-test:
    name: E2E Tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/e2e-test.yml
    with:
      artifact-name-prefix: 'ci-e2e'
