name: Flake CI - Build APK with Nix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-with-nix:
    name: Build ARM v7 Debug APK with Nix Flake
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check if deps.json needs updating
        id: check-deps
        run: |
          if [ ! -f "deps.json" ] || [ "$(jq '.dependencies | length' deps.json 2>/dev/null || echo 0)" -eq 0 ]; then
            echo "needs-update=true" >> $GITHUB_OUTPUT
            echo "⚠️  deps.json is missing or empty - will generate it"
          else
            echo "needs-update=false" >> $GITHUB_OUTPUT
            echo "✓ deps.json exists and has dependencies"
          fi

      - name: Generate deps.json (if needed)
        if: steps.check-deps.outputs.needs-update == 'true'
        run: |
          echo "Generating deps.json for Gradle dependencies..."

          # Build the update script
          UPDATE_SCRIPT=$(nix build .#apk.mitmCache.updateScript --print-out-paths --no-link)
          echo "Update script: $UPDATE_SCRIPT"

          # Run the update script to generate deps.json
          $UPDATE_SCRIPT

          echo "✓ deps.json generated successfully"
          echo "Dependencies found: $(jq '.dependencies | length' deps.json)"

      - name: Commit updated deps.json
        if: steps.check-deps.outputs.needs-update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add deps.json
          git commit -m "chore: Update Gradle dependencies lock file (deps.json)

          Auto-generated by Nix flake build system
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}"

          git push

          echo "✓ deps.json committed and pushed"

      - name: Build ARM v7 debug APK hermetically
        run: |
          echo "Building APK using hermetic Nix build (offline, reproducible)..."
          nix build .#apk --print-build-logs

      - name: Prepare APK for upload
        run: |
          mkdir -p build-output
          cp result/app-armeabi-v7a-debug.apk build-output/

          echo "APK Size:"
          ls -lh build-output/app-armeabi-v7a-debug.apk

          echo "APK SHA256:"
          sha256sum build-output/app-armeabi-v7a-debug.apk

      - name: Upload ARM v7 debug APK
        uses: actions/upload-artifact@v5
        with:
          name: app-armeabi-v7a-debug
          path: build-output/app-armeabi-v7a-debug.apk
          compression-level: 0
          retention-days: 30

      - name: Upload build summary
        if: always()
        run: |
          {
            echo "## Nix Flake Hermetic Build Summary"
            echo ""
            echo "**Build Type:** Hermetic (Offline, Reproducible)"
            echo "**Architecture:** ARM v7 (armeabi-v7a)"
            echo "**Build Variant:** Debug"
            echo ""
            echo "### Build Details"
            echo "- Workflow: \`${{ github.workflow }}\`"
            echo "- Run ID: \`${{ github.run_id }}\`"
            echo "- Commit: \`${{ github.sha }}\`"
            echo "- Dependencies: \`$(jq '.dependencies | length' deps.json 2>/dev/null || echo 'N/A')\` cached Gradle artifacts"
            echo ""
            if [ -f "build-output/app-armeabi-v7a-debug.apk" ]; then
              echo "### APK Information"
              echo '```'
              ls -lh build-output/app-armeabi-v7a-debug.apk
              echo '```'
              echo ""
              echo "**SHA256:** \`$(sha256sum build-output/app-armeabi-v7a-debug.apk | cut -d' ' -f1)\`"
              echo ""
              echo "### Hermetic Build Features"
              echo "- ✅ Fully reproducible build"
              echo "- ✅ No network access during build (offline)"
              echo "- ✅ All dependencies cached in Nix store"
              echo "- ✅ Deterministic output"
            fi
          } >> $GITHUB_STEP_SUMMARY
